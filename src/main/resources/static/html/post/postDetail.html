<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시물 상세보기</title>
  <link rel="stylesheet" href="/css/postDetail.css">
</head>
<body>
<div class="modal" id="postModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">&times;</button> <!-- 모달 닫기 버튼 -->
    <div class="left-content">
      <button class="nav-button prev" onclick="prevImage(event)">&#10094;</button>
      <!-- 이전 이미지 버튼 -->
      <div id="imageContainer" class="image-slider"></div> <!-- 이미지 슬라이더 컨테이너 -->
      <button class="nav-button next" onclick="nextImage(event)">&#10095;</button>
      <!-- 다음 이미지 버튼 -->
    </div>
    <div class="right-content">
      <div class="header">
        닉네임~~~
        <div class="more-options" onclick="toggleDropdownMenu()">⋮</div> <!-- 더보기 옵션 버튼 -->
      </div>
      <div id="postContent" class="content"></div> <!-- 게시물 내용 컨테이너 -->
    </div>
  </div>
</div>

<div class="dropdown-menu" id="dropdownMenu"> <!-- 드롭다운 메뉴 -->
  <a href="javascript:void(0);" class="delete" onclick="deletePost()">삭제</a> <!-- 삭제 -->
  <a href="javascript:void(0);" onclick="openEditModal()">수정</a> <!-- 수정 -->
  <a href="javascript:void(0);">다른 사람에게 좋아요 수 숨기기</a> <!-- 좋아요 수 숨기기 -->
  <a href="javascript:void(0);">댓글 기능 해제</a> <!-- 댓글 기능 해제 -->
  <a href="javascript:void(0);">링크 복사</a> <!-- 링크 복사 -->
  <a href="javascript:void(0);" onclick="toggleDropdownMenu()">취소</a> <!-- 취소 -->
</div>

<div class="edit-modal" id="editModal"> <!-- 수정 모달 -->
  <div class="edit-modal-content">
    <button class="close-btn" onclick="closeEditModal()">&times;</button> <!-- 수정 모달 닫기 버튼 -->
    <div class="edit-left-content">
      <button class="nav-button prev" onclick="prevEditImage(event)">&#10094;</button>
      <!-- 이전 이미지 버튼 -->
      <div id="editImagePreviewContainer"></div> <!-- 이미지 미리보기 컨테이너 -->
      <button class="nav-button next" onclick="nextEditImage(event)">&#10095;</button>
      <!-- 다음 이미지 버튼 -->
    </div>
    <div class="edit-right-content">
      <div class="header">게시물 수정</div>
      <form id="editForm" enctype="multipart/form-data">
        <input type="text" id="editContent" name="content" placeholder="내용을 입력하세요">
        <!-- 수정 내용 입력 -->
        <button type="button" onclick="submitEdit()">저장</button> <!-- 저장 버튼 -->
        <button type="button" onclick="closeEditModal()">취소</button> <!-- 취소 버튼 -->
      </form>
    </div>
  </div>
</div>

<script>
  let currentPostId;
  let currentImageIndex = 0;
  let editImageIndex = 0;
  let imageUrls = [];

  async function loadPostData(postId) { // 게시물 데이터 로드
    try {
      const response = await fetch(`/api/posts/detail/${postId}`);
      if (!response.ok) {
        throw new Error('Network response was not ok ' + response.statusText);
      }
      const postData = await response.json();
      currentPostId = postId;

      const postContent = document.getElementById('postContent');
      postContent.innerHTML = `<p>${postData.content}</p>`; // 게시물 내용 설정

      const imageContainer = document.getElementById('imageContainer');
      imageContainer.innerHTML = ''; // 기존 이미지 초기화
      if (Array.isArray(postData.imageUrls)) {
        imageUrls = postData.imageUrls.filter(
            url => url.startsWith("http://") || url.startsWith("https://"));
        imageUrls.forEach((url, index) => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = `image ${index + 1}`;
          img.className = index === 0 ? 'active' : ''; // 첫 번째 이미지 활성화
          img.onerror = () => {
            console.error('Failed to load image:', url);
            img.parentElement.removeChild(img); // 이미지 로드 실패 시 요소 제거
          };
          imageContainer.appendChild(img);
        });
      } else {
        console.error('imageUrls is not an array', postData.imageUrls);
      }
    } catch (error) {
      console.error('Error fetching post data:', error);
    }
  }

  function openModal() {
    document.getElementById('postModal').style.display = 'flex'; // 모달 열기
  }

  function closeModal() {
    document.getElementById('postModal').style.display = 'none'; // 모달 닫기
  }

  function toggleDropdownMenu() {
    const dropdownMenu = document.getElementById('dropdownMenu');
    dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block'; // 드롭다운 메뉴 토글
  }

  function openEditModal() {
    document.getElementById('editModal').style.display = 'flex'; // 수정 모달 열기
    document.getElementById('editContent').value = document.querySelector(
        '#postContent p').innerText; // 수정 내용 설정

    const editImagePreviewContainer = document.getElementById('editImagePreviewContainer');
    editImagePreviewContainer.innerHTML = ''; // 기존 이미지 초기화
    imageUrls.forEach((url, index) => {
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Preview Image';
      img.className = index === 0 ? 'active' : ''; // 첫 번째 이미지 활성화
      img.onerror = () => {
        console.error('Failed to load image:', url);
        img.parentElement.removeChild(img); // 이미지 로드 실패 시 요소 제거
      };
      editImagePreviewContainer.appendChild(img);
    });

    toggleDropdownMenu(); // 드롭다운 메뉴 닫기
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none'; // 수정 모달 닫기
  }

  async function submitEdit() {
    const editedContent = document.getElementById('editContent').value;

    const editRequest = new FormData();
    editRequest.append('content', editedContent); // 수정 내용 추가

    try {
      const response = await fetch(`/api/posts/edit/${currentPostId}`, {
        method: 'POST', // PATCH에서 POST로 변경
        body: editRequest
      });
      if (!response.ok) {
        throw new Error('Failed to update post');
      }
      alert('게시물이 수정되었습니다.');
      closeEditModal(); // 수정 모달 닫기
      loadPostData(currentPostId); // 수정된 게시물 데이터 로드
    } catch (error) {
      console.error('Error updating post:', error);
      alert('게시물 수정에 실패했습니다.');
    }
  }

  async function deletePost() {
    if (currentPostId) {
      try {
        const response = await fetch(`/api/posts/delete/${currentPostId}`, {
          method: 'POST' // DELETE에서 POST로 변경
        });
        if (!response.ok) {
          throw new Error('Failed to delete post');
        }
        alert('게시물이 삭제되었습니다.');
        window.location.href = '/'; // 게시물 삭제 후 메인 페이지로 리다이렉트
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('게시물 삭제에 실패했습니다.');
      }
    } else {
      console.error('No postId found in URL');
    }
  }

  function showImage(index) {
    const images = document.querySelectorAll('#imageContainer img');
    images.forEach((img, idx) => {
      img.className = (idx === index) ? 'active' : ''; // 활성화된 이미지 설정
    });
  }

  function prevImage(event) {
    event.preventDefault();
    if (imageUrls.length > 1) {
      currentImageIndex = (currentImageIndex === 0) ? imageUrls.length - 1 : currentImageIndex - 1;
      showImage(currentImageIndex); // 이전 이미지 표시
    }
  }

  function nextImage(event) {
    event.preventDefault();
    if (imageUrls.length > 1) {
      currentImageIndex = (currentImageIndex === imageUrls.length - 1) ? 0 : currentImageIndex + 1;
      showImage(currentImageIndex); // 다음 이미지 표시
    }
  }

  function showEditImage(index) {
    const images = document.querySelectorAll('#editImagePreviewContainer img');
    images.forEach((img, idx) => {
      img.className = (idx === index) ? 'active' : ''; // 활성화된 이미지 설정
    });
  }

  function prevEditImage(event) {
    event.preventDefault();
    if (imageUrls.length > 1) {
      editImageIndex = (editImageIndex === 0) ? imageUrls.length - 1 : editImageIndex - 1;
      showEditImage(editImageIndex); // 이전 이미지 표시
    }
  }

  function nextEditImage(event) {
    event.preventDefault();
    if (imageUrls.length > 1) {
      editImageIndex = (editImageIndex === imageUrls.length - 1) ? 0 : editImageIndex + 1;
      showEditImage(editImageIndex); // 다음 이미지 표시
    }
  }

  // URL에서 postId를 추출하여 로드
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('postId');
    if (postId) {
      loadPostData(postId); // 게시물 데이터 로드
      openModal(); // 모달 열기
    } else {
      console.error('No postId found in URL');
    }
  });
</script>
</body>
</html>
