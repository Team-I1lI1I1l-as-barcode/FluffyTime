<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>새 게시물 만들기</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .modal, .draft-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content, .draft-modal-content {
      background-color: #ffffff;
      width: 70%;
      max-width: 1200px;
      height: 70%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      overflow: hidden;
    }

    .header {
      text-align: center;
      padding: 15px;
      border-bottom: 1px solid #ccc;
      font-size: 18px;
      font-weight: bold;
    }

    .content {
      display: flex;
      flex: 1;
    }

    .left-content {
      flex: 3.5;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      position: relative;
    }

    .left-content img {
      max-width: 100%;
      max-height: 100%;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .left-content.fullscreen img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .left-content input {
      display: none;
    }

    .left-content label {
      cursor: pointer;
    }

    .left-content .nav-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(0, 0, 0, 0.5);
      border: none;
      color: white;
      font-size: 24px;
      padding: 10px;
      cursor: pointer;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .left-content .prev {
      left: 10px;
    }

    .left-content .next {
      right: 10px;
    }

    .share-button {
      background-color: #fcd21d;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 4px;
    }

    .right-content {
      flex: 1.5;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #ccc;
    }

    .profile {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .profile img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .right-content textarea {
      resize: none;
      width: calc(100% - 20px);
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 4px;
      border: none;
    }

    .right-content input[type="text"] {
      width: calc(100% - 20px);
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 4px;
      border: none;
    }

    .char-count {
      text-align: right;
      font-size: 12px;
      color: #999;
      margin-bottom: 10px;
    }

    .toggle {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 34px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #f0b90b;
    }

    input:checked + .slider:before {
      transform: translateX(14px);
    }

    .options {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-top: auto;
    }

    .options a {
      color: #fcd21d;
      margin-bottom: 10px;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }

    .options a:hover {
      color: #f0b90b;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #fff;
    }

    .complete {
      display: none;
      text-align: center;
      margin-top: 20px;
    }

    .post-textarea {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
      width: calc(100% - 20px);
    }

    hr {
      border: none;
      border-top: 1px solid #ccc;
      margin: 10px 0;
      width: calc(100% + 40px);
      transform: translateX(-20px);
    }

    .temp-posts {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    .temp-post {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 10px;
      width: 80%;
    }

    .temp-post p {
      margin: 0;
      flex: 1;
    }

    .temp-post button {
      border: none;
      background: none;
      color: red;
      cursor: pointer;
    }

    .delete-icon {
      position: absolute;
      top: 10px;
      left: 10px;
      background: url('/static/image/post/trash.jpg') no-repeat center center;
      background-size: contain;
      width: 30px;
      height: 30px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
<button onclick="openModal()">새 게시물 만들기</button> <!-- 새 게시물 만들기 모달 열기 버튼 -->

<div class="modal" id="postModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">&times;</button> <!-- 모달 닫기 버튼 -->
    <div class="header">새 게시물을 만들기</div>
    <form id="postForm" class="content" enctype="multipart/form-data" method="post">
      <div class="left-content" id="leftContent">
        <label for="images">
          <div id="imagePreviewContainer">
            <img id="imagePreview" src="/image/post/photo.JPG">
          </div>
          <p id="dragDropText">사진과 동영상을 여기에 끌어다 놓으세요</p>
          <input type="file" id="images" name="images" accept="image/*" multiple
                 onchange="previewImages(event)"> <!-- 이미지 파일 선택 입력 -->
        </label>
        <button type="button" class="share-button" id="shareButton"
                onclick="document.getElementById('images').click()">공유하기
        </button>
        <button class="nav-button prev" onclick="prevImage(event)">&#10094;</button>
        <button class="nav-button next" onclick="nextImage(event)">&#10095;</button>
      </div>
      <div class="right-content">
        <div>
          <div class="profile">
            <img src="/image/post/profile-placeholder.JPG" alt="프로필 이미지">
            <span>happy</span>
          </div>
          <textarea id="content" name="content" class="post-textarea" rows="10"
                    placeholder="내용을 입력하세요" maxlength="2200" required
                    oninput="updateCharCount()"></textarea>
          <div class="char-count" id="charCount">0 / 2200</div>
          <hr>
          <input type="text" id="tags" name="tags" class="post-textarea" placeholder="태그"
                 maxlength="10">
          <hr>
          <div class="toggle">
            <label for="hideLikes">이 게시물의 좋아요 수 및 조회수 숨기기</label>
            <label class="switch">
              <input type="checkbox" name="hideLikes" id="hideLikes">
              <span class="slider"></span>
            </label>
          </div>
          <hr>
          <div class="toggle">
            <label for="disableComments">댓글 기능 해제</label>
            <label class="switch">
              <input type="checkbox" name="disableComments" id="disableComments">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        <hr>
        <div class="options">
          <a href="#" onclick="openDraftModal()">임시 저장 글 불러오기</a>
          <a href="#" onclick="saveAsTemp(event)">임시저장</a>
          <a href="#" onclick="submitPost(event)">공유하기</a>
        </div>
      </div>
    </form>
    <div class="complete" id="complete-container">
      <p>게시물 등록이 완료되었습니다!</p>
    </div>
  </div>
</div>

<div class="draft-modal" id="draftModal">
  <div class="draft-modal-content">
    <button class="close-btn" onclick="closeDraftModal()">&times;</button>
    <div class="header">임시 저장</div>
    <div class="temp-posts" id="tempPostsContainer"></div>
  </div>
</div>

<script>
  let currentImageIndex = 0;
  let imagesArray = [];
  let currentDraftPostId = null;

  // 새 게시물 만들기 모달 열기
  function openModal() {
    document.getElementById('postModal').style.display = 'flex';
  }

  // 새 게시물 만들기 모달 닫기
  function closeModal() {
    document.getElementById('postModal').style.display = 'none';
  }

  function openDraftModal() {
    document.getElementById('draftModal').style.display = 'flex'; // 임시 저장 모달 열기
    loadDraft(); // 임시 저장 글 불러오기
  }

  function closeDraftModal() {
    document.getElementById('draftModal').style.display = 'none'; // 임시 저장 모달 닫기
  }

  function showComplete() {
    document.querySelector('.content').style.display = 'none'; // 게시물 등록 완료 메시지 표시
    document.getElementById('complete-container').style.display = 'block'; // 게시물 등록 완료 메시지 표시
  }

  function previewImages(event) {
    const files = event.target.files;
    const previewContainer = document.getElementById('imagePreviewContainer');
    const dragDropText = document.getElementById('dragDropText');
    const shareButton = document.getElementById('shareButton');
    const leftContent = document.getElementById('leftContent');

    previewContainer.innerHTML = '';
    imagesArray = [];

    if (files.length > 11) {
      alert('이미지는 최대 10장까지 업로드할 수 있습니다.');
      event.target.value = ""; // 파일 선택 초기화
      return;
    }

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const reader = new FileReader();
      reader.onload = function (e) {
        imagesArray.push(e.target.result);
        if (i === 0) { // 첫 번째 이미지를 미리 보기로 설정
          const img = document.createElement('img');
          img.src = e.target.result;
          img.classList.add('photo');
          previewContainer.appendChild(img);
        }
      };
      reader.readAsDataURL(file);
    }

    if (files.length > 0) {
      dragDropText.style.display = 'none'; // 드래그 앤 드롭 텍스트 숨기기
      shareButton.style.display = 'none'; // 공유하기 버튼 숨기기
      leftContent.classList.add('fullscreen'); // 이미지를 전체 영역에 표시
    }
  }

  function updateCharCount() {
    const content = document.getElementById('content').value;
    const charCount = document.getElementById('charCount');
    charCount.textContent = `${content.length} / 2200`; // 글자 수 업데이트
  }

  async function saveAsTemp(event) {
    event.preventDefault();

    const content = document.getElementById('content').value;
    const images = document.getElementById('images').files;

    if (!content) {
      alert('내용을 입력하세요.');
      return;
    }

    if (images.length > 10) {
      alert('이미지는 최대 10장까지 업로드할 수 있습니다.');
      return;
    }

    const postRequest = {
      content: content,
      tempStatus: 'TEMP',
      imageUrls: []
    };

    const formData = new FormData();
    formData.append('post', new Blob([JSON.stringify(postRequest)], {type: 'application/json'}));
    for (let i = 0; i < images.length; i++) {
      formData.append('images', images[i]);
    }

    fetch('/api/posts/temp-reg', {
      method: 'POST',
      body: formData
    }).then(response => {
      if (response.ok) {
        alert('임시 저장되었습니다.');
        closeModal();
      } else {
        alert('임시 저장에 실패했습니다.');
      }
    }).catch(error => {
      alert('임시 저장 중 오류가 발생했습니다.');
      console.error('Error:', error);
    });
  }

  async function submitPost(event) {
    event.preventDefault();

    const content = document.getElementById('content').value;
    const images = document.getElementById('images').files;

    if (!content) {
      alert('내용을 입력하세요.');
      return;
    }

    if (images.length > 10) {
      alert('이미지는 최대 10장까지 업로드할 수 있습니다.');
      return;
    }

    const postRequest = {
      tempId: currentDraftPostId, // 현재 임시 저장된 글 ID를 추가
      content: content,
      tempStatus: 'SAVE',
      imageUrls: []
    };

    const formData = new FormData();
    formData.append('post', new Blob([JSON.stringify(postRequest)], {type: 'application/json'}));
    for (let i = 0; i < images.length; i++) {
      formData.append('images', images[i]);
    }

    fetch('/api/posts/reg', {
      method: 'POST',
      body: formData
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('게시물 등록에 실패했습니다.');
      }
    }).then(postId => {
      window.location.href = `/html/post/postDetail.html?postId=${postId}`; // 게시물 상세 페이지로 이동
    }).catch(error => {
      alert(error.message);
    });
  }

  async function loadDraft() {
    const userId = 1; // 나중에 수정
    const tempPostsContainer = document.getElementById('tempPostsContainer');
    tempPostsContainer.innerHTML = '';

    try {
      const response = await fetch(`/api/posts/temp-posts/list?userId=${userId}`);
      if (response.ok) {
        const tempPosts = await response.json();
        tempPosts.forEach(post => {
          const postElement = document.createElement('div');
          postElement.classList.add('temp-post');
          postElement.innerHTML = `
            <p>${post.content}</p>
            <button onclick="deleteTempPost(${post.postId})">삭제</button>
          `;
          postElement.onclick = () => continueDraft(post); // 임시 저장 글 불러오기
          tempPostsContainer.appendChild(postElement);
        });
        tempPostsContainer.style.display = 'flex';
      } else {
        alert('임시 저장 글 불러오기에 실패했습니다.');
      }
    } catch (error) {
      alert('임시 저장 글 불러오기 중 오류가 발생했습니다.');
      console.error('Error:', error);
    }
  }

  function continueDraft(post) {
    document.getElementById('content').value = post.content; // 임시 저장 글 내용 불러오기
    updateCharCount();
    currentDraftPostId = post.postId;

    const previewContainer = document.getElementById('imagePreviewContainer');
    previewContainer.innerHTML = '';
    imagesArray = post.imageUrls;
    currentImageIndex = 0;
    displayImages();

    closeDraftModal();
    openModal();
  }

  function displayImages() {
    const previewContainer = document.getElementById('imagePreviewContainer');
    previewContainer.innerHTML = '';

    if (imagesArray.length > 0) {
      const img = document.createElement('img');
      img.src = imagesArray[currentImageIndex];
      img.classList.add('photo');
      previewContainer.appendChild(img);

      if (imagesArray.length > 1) {
        const prevButton = document.createElement('button');
        prevButton.classList.add('nav-button', 'prev');
        prevButton.innerHTML = '&#10094;';
        prevButton.onclick = (e) => prevImage(e);
        previewContainer.appendChild(prevButton);

        const nextButton = document.createElement('button');
        nextButton.classList.add('nav-button', 'next');
        nextButton.innerHTML = '&#10095;';
        nextButton.onclick = (e) => nextImage(e);
        previewContainer.appendChild(nextButton);
      }
    }

    if (imagesArray.length > 0) {
      document.getElementById('dragDropText').style.display = 'none'; // 드래그 앤 드롭 텍스트 숨기기
      document.getElementById('shareButton').style.display = 'none'; // 공유하기 버튼 숨기기
      document.getElementById('leftContent').classList.add('fullscreen'); // 이미지를 전체 영역에 표시
    }
  }

  function deleteImage(event, index) {
    event.stopPropagation();
    imagesArray.splice(index, 1); // 이미지 삭제
    displayImages();
  }

  async function deleteTempPost(postId) {
    try {
      const response = await fetch(`/api/posts/temp-delete/${postId}`, {
        method: 'DELETE'
      });
      if (response.ok) {
        loadDraft(); // 임시 저장 글 목록 다시 불러오기
      } else {
        alert('임시 저장 글 삭제에 실패했습니다.');
      }
    } catch (error) {
      alert('임시 저장 글 삭제 중 오류가 발생했습니다.');
      console.error('Error:', error);
    }
  }

  function prevImage(event) {
    event.preventDefault();
    if (imagesArray.length > 1) {
      currentImageIndex = (currentImageIndex === 0) ? imagesArray.length - 1 : currentImageIndex
          - 1;
      displayImages(); // 이전 이미지 표시
    }
  }

  function nextImage(event) {
    event.preventDefault();
    if (imagesArray.length > 1) {
      currentImageIndex = (currentImageIndex === imagesArray.length - 1) ? 0 : currentImageIndex
          + 1;
      displayImages(); // 다음 이미지 표시
    }
  }
</script>
</body>
</html>
